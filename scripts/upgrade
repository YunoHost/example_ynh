#!/bin/bash

set -eu

# Get multi-instances specific variables
app=$YNH_APP_INSTANCE_NAME

# Source app helpers
. /usr/share/yunohost/helpers

# Retrieve app settings
domain=$(ynh_app_setting_get "$app" domain)
path=$(ynh_app_setting_get "$app" path)
path=${path%/}
is_public=$(ynh_app_setting_get "$app" is_public)
with_mysql=$(ynh_app_setting_get "$app" with_mysql)
password=$(ynh_app_setting_get "$app" password)
user=$(ynh_app_setting_get "$app" user)

([[ -n "$with_mysql" ]] && [[ -n "$password" ]] && [[ -n "$user" ]]) \
  || ynh_die "The app changed and can not be automatically upgraded. \
You will have to manually upgrade it following those instructions: \
https://github.com/garwinch/Yuno_app_cagette#upgrade"

# Check destination directory
DESTDIR="/var/www/$app"
[[ ! -d $DESTDIR ]] && ynh_die \
"The destination directory '$DESTDIR' does not exist.\
 The app is not correctly installed, you should remove it first."

# Harden SSH connection for the user
sudo sed -i "/##-> ${app}/,/##<- ${app}/d" /etc/ssh/sshd_config
echo "##-> ${app}
# Hardening user connection
Match User ${user}
  ChrootDirectory %h
  ForceCommand internal-sftp
  AllowTcpForwarding no
  PermitTunnel no
  X11Forwarding no
##<- ${app}" | sudo tee -a /etc/ssh/sshd_config >/dev/null

# Fix permissions
sudo chown -hR "${user}:" "$DESTDIR"

# Home directory of the user need to be owned by root to allow
# SFTP connections
sudo chown root: "$DESTDIR"

# Set SSOwat rules
[[ $is_public -eq 1 ]] \
  && ynh_app_setting_set "$app" skipped_uris "/"

